name: Create Release on Netlify Deploy

on:
    repository_dispatch:
        types: [webhook_trigger]

concurrency:
    group: netlify-release
    cancel-in-progress: false

jobs:
    create-release:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Check if on master branch
              id: check_branch
              run: |
                  current_branch=$(git branch --show-current)
                  echo "Current branch: $current_branch"

                  if [ "$current_branch" = "master" ]; then
                    echo "On master branch, proceeding with release"
                    echo "is_master=true" >> $GITHUB_OUTPUT
                  else
                    echo "Not on master branch ($current_branch), skipping release"
                    echo "is_master=false" >> $GITHUB_OUTPUT
                  fi

            - name: Check if relevant files changed
              if: steps.check_branch.outputs.is_master == 'true'
              id: check_changes
              run: |
                  # For webhook triggers, check recent commits for relevant file changes
                  changed_files=$(git diff --name-only HEAD~3 HEAD)

                  echo "Changed files in recent commits:"
                  echo "$changed_files"

                  # Check if any of our target files changed
                  relevant_change=false
                  for file in index.html app.js style.css; do
                    if echo "$changed_files" | grep -q "^$file$"; then
                      echo "Relevant file changed: $file"
                      relevant_change=true
                      break
                    fi
                  done

                  echo "relevant_change=$relevant_change" >> $GITHUB_OUTPUT

            - name: Check for existing release
              if: steps.check_branch.outputs.is_master == 'true' && steps.check_changes.outputs.relevant_change == 'true'
              id: check_existing
              run: |
                  # Check if current HEAD commit already has a release
                  current_commit=$(git rev-parse HEAD)
                  echo "Current commit: $current_commit"

                  existing_release=$(gh release list --json tagName,targetCommitish --jq ".[] | select(.targetCommitish == \"$current_commit\") | .tagName" 2>/dev/null || echo "")

                  if [ -n "$existing_release" ]; then
                    echo "Release already exists for commit $current_commit: $existing_release"
                    echo "should_create=false" >> $GITHUB_OUTPUT
                  else
                    echo "No existing release found for current commit"
                    echo "should_create=true" >> $GITHUB_OUTPUT
                  fi
              env:
                  GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

            - name: Generate release tag
              if: steps.check_branch.outputs.is_master == 'true' && steps.check_changes.outputs.relevant_change == 'true' && steps.check_existing.outputs.should_create == 'true'
              id: release_tag
              run: |
                  # Generate base date in YY.MM.DD format using IST (GMT+5:30)
                  base_date=$(TZ='Asia/Kolkata' date +'%y.%m.%d')
                  echo "Base date: $base_date"

                  # Get all releases for today (looking for v prefix)
                  today_releases=$(gh release list --json tagName --jq '.[] | select(.tagName | startswith("v'$base_date'.")) | .tagName' 2>/dev/null || echo "")

                  echo "Today's releases: $today_releases"

                  if [ -z "$today_releases" ]; then
                    # No releases today, start with build 1
                    build_number=1
                  else
                    # Find the highest build number for today (remove v prefix and base date)
                    highest_build=$(echo "$today_releases" | sed "s/^v$base_date\.//" | sort -n | tail -1)
                    echo "Highest build found: $highest_build"
                    build_number=$((highest_build + 1))
                  fi

                  release_tag="$base_date.$build_number"
                  echo "Generated release tag: $release_tag"
                  echo "release_tag=$release_tag" >> $GITHUB_OUTPUT
              env:
                  GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

            - name: Get latest release tag
              if: steps.check_branch.outputs.is_master == 'true' && steps.check_changes.outputs.relevant_change == 'true' && steps.check_existing.outputs.should_create == 'true'
              id: latest_release
              run: |
                  latest_tag=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null || echo "")
                  echo "latest_tag=${latest_tag}" >> $GITHUB_OUTPUT
              env:
                  GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

            - name: Get git history since last release
              if: steps.check_branch.outputs.is_master == 'true' && steps.check_changes.outputs.relevant_change == 'true' && steps.check_existing.outputs.should_create == 'true'
              id: git_history
              run: |
                  if [ -n "${{ steps.latest_release.outputs.latest_tag }}" ]; then
                    echo "Getting commit history since ${{ steps.latest_release.outputs.latest_tag }}"
                    # Get all commits since last release with better formatting, excluding merge commits and duplicates
                    commits=$(git log --oneline --no-merges --pretty=format:"- **%s** (%h)" ${{ steps.latest_release.outputs.latest_tag }}..HEAD | head -15)
                    commit_count=$(git rev-list --count --no-merges ${{ steps.latest_release.outputs.latest_tag }}..HEAD)
                  else
                    echo "No previous release found, getting recent commits"
                    commits=$(git log --oneline --no-merges --pretty=format:"- **%s** (%h)" -10)
                    commit_count=$(git rev-list --count --no-merges HEAD)
                  fi

                  if [ -z "$commits" ]; then
                    commits="- Initial release"
                    commit_count=1
                  else
                    # Remove duplicate commit messages (same text, different hashes)
                    commits=$(echo "$commits" | awk '!seen[substr($0, index($0, "**") + 2, index($0, "** (") - index($0, "**") - 2)]++')
                  fi

                  # Save commits to output, handling multiline
                  echo "git_history<<EOF" >> $GITHUB_OUTPUT
                  echo "$commits" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

                  echo "commit_count=$commit_count" >> $GITHUB_OUTPUT

            - name: Create Release
              if: steps.check_branch.outputs.is_master == 'true' && steps.check_changes.outputs.relevant_change == 'true' && steps.check_existing.outputs.should_create == 'true'
              env:
                  GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
              run: |
                  # Get current IST date and time for triggered at field
                  triggered_time=$(TZ='Asia/Kolkata' date +'%Y-%m-%d %H:%M:%S IST')

                  gh release create v${{ steps.release_tag.outputs.release_tag }} \
                    --title "Release v${{ steps.release_tag.outputs.release_tag }}" \
                    --notes "## üöÄ Automated Release

                  This release was automatically created following a successful deployment.

                  ### ÔøΩ Changelog (${{ steps.git_history.outputs.commit_count }} commits)
                  ${{ steps.git_history.outputs.git_history }}

                  ### üîó Previous Version
                  Previous release: ${{ steps.latest_release.outputs.latest_tag || 'None' }}

                  ### ‚è∞ Release Information  
                  - **Released on**: $triggered_time
                  - **Build version**: v${{ steps.release_tag.outputs.release_tag }}
                  - **Deployment**: Successfully deployed to Netlify"

            - name: Skip release notification
              if: steps.check_branch.outputs.is_master == 'true' && steps.check_changes.outputs.relevant_change == 'false'
              run: |
                  echo "No relevant file changes detected. Skipping release creation."
                  echo "Only changes to index.html, app.js, or style.css trigger releases."

            - name: Skip duplicate release notification
              if: steps.check_branch.outputs.is_master == 'true' && steps.check_changes.outputs.relevant_change == 'true' && steps.check_existing.outputs.should_create == 'false'
              run: |
                  echo "Release already exists for current commit. Skipping duplicate release creation."
                  echo "This prevents multiple releases for the same code changes."

            - name: Skip non-master branch notification
              if: steps.check_branch.outputs.is_master == 'false'
              run: |
                  echo "Workflow triggered from non-master branch. Skipping release creation."
                  echo "Releases are only created from master branch deployments."
